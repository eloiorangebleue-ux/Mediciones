<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard Salud Avanzado</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #f4f7fa;
      --card: #ffffff;
      --primary: #4a90e2;
      --accent: #50e3c2;
      --warn: #e94e77;
      --text: #34495e;
      --radius: 10px;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Poppins',sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.4;
    }
    .container { max-width:1000px; margin:40px auto; padding:0 20px; }
    h1 { text-align:center; margin-bottom:20px; font-weight:600; }
    .filters { display:flex; gap:12px; justify-content:center; margin-bottom:30px; }
    .filters select {
      padding:8px 12px; border:1px solid #ccc; border-radius:6px; background:#fff; font-size:.95em;
    }
    .summary-cards {
      display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:20px; margin-bottom:30px;
    }
    .card {
      background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:20px; text-align:center;
    }
    .card h3 { font-size:1em; margin-bottom:6px; color:#777; }
    .card p {
      font-size:1.8em; margin-bottom:4px; font-weight:600; color:var(--primary);
    }
    .card .trend {
      font-size:.9em; font-weight:600;
    }
    .trend.up { color:var(--accent); }
    .trend.down { color:var(--warn); }
    .chart-wrapper {
      background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:20px; margin-bottom:30px;
    }
    .chart-controls { text-align:center; margin-bottom:12px; }
    .chart-controls select {
      padding:6px 10px; font-size:.9em; border-radius:4px; border:1px solid #ccc;
    }
    .chart-wrapper canvas { width:100% !important; height:320px !important; }
    .comparison {
      background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:20px; margin-bottom:40px;
    }
    .comparison h2 { text-align:center; margin-bottom:16px; color:var(--primary); }
    table {
      width:100%; border-collapse:collapse; margin-top:10px;
    }
    th, td {
      padding:12px 8px; border-bottom:1px solid #eee; text-align:center; font-size:.9em;
    }
    th { background:var(--primary); color:#fff; font-weight:500; }
    tr:last-child td { border-bottom:none; }
    .positive { color:var(--accent); font-weight:600; }
    .negative { color:var(--warn); font-weight:600; }
    @media(max-width:600px){
      .filters { flex-direction:column; }
      .chart-wrapper canvas { height:260px!important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä Dashboard Salud Avanzado</h1>
    <div class="filters">
      <select id="clienteSelect"><option value="">‚ÄîSelecciona Cliente‚Äî</option></select>
      <select id="metricSelect">
        <option value="Peso corporal Kg">Peso (Kg)</option>
        <option value="BMI (√çndice Masa Corporal)">BMI</option>
        <option value="% Grasa corporal">% Grasa</option>
        <option value="Masa muscular Kg">Masa Muscular</option>
        <option value="% Agua total del cuerpo">% Agua</option>
        <option value="BMR (Tasa Metab√≥lica Basal)">BMR</option>
        <option value="Edad metab√≥lica">Edad Metab√≥lica</option>
        <option value="Nivel de grasa visceral">Grasa Visceral</option>
      </select>
    </div>

    <div class="summary-cards" id="cardsContainer">
      <!-- tarjetas generadas din√°micamente -->
    </div>

    <div class="chart-wrapper">
      <div class="chart-controls">
        <label>M√©trica: 
          <select id="chartMetricSelect">
            <option value="Peso corporal Kg">Peso</option>
            <option value="BMI (√çndice Masa Corporal)">BMI</option>
            <option value="% Grasa corporal">% Grasa</option>
            <option value="Masa muscular Kg">Masa Muscular</option>
            <option value="% Agua total del cuerpo">% Agua</option>
            <option value="BMR (Tasa Metab√≥lica Basal)">BMR</option>
            <option value="Edad metab√≥lica">Edad Metab√≥lica</option>
            <option value="Nivel de grasa visceral">Grasa Visceral</option>
          </select>
        </label>
      </div>
      <canvas id="evolChart"></canvas>
    </div>

    <div class="comparison">
      <h2>üîç Comparativa y An√°lisis</h2>
      <table>
        <thead>
          <tr><th>M√©trica</th><th>Inicio</th><th>√öltimo</th><th>Œî</th><th>Estado</th></tr>
        </thead>
        <tbody id="comparisonBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const SHEET_URL = 'https://script.google.com/macros/s/.../exec';
    let rawData = [];

    async function fetchData(params='') {
      const res = await fetch(SHEET_URL + params);
      return res.json();
    }

    function createCards(data) {
      const latest = data[data.length-1];
      const keys = [
        {k:'Peso corporal Kg',label:'Peso (Kg)'},
        {k:'BMI (√çndice Masa Corporal)',label:'BMI'},
        {k:'% Grasa corporal',label:'% Grasa'},
        {k:'Masa muscular Kg',label:'Masa Muscular'},
        {k:'% Agua total del cuerpo',label:'% Agua'},
        {k:'BMR (Tasa Metab√≥lica Basal)',label:'BMR'},
        {k:'Edad metab√≥lica',label:'Edad Metab√≥lica'},
        {k:'Nivel de grasa visceral',label:'Grasa Visceral'}
      ];
      const container = document.getElementById('cardsContainer');
      container.innerHTML = '';
      keys.forEach(m => {
        const first = parseFloat(data[0][m.k]), last = parseFloat(latest[m.k]);
        const diff = (last - first).toFixed(1);
        const pct = ((diff/first)*100).toFixed(1);
        const trend = diff<0 ? 'down' : 'up';
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>${m.label}</h3>
          <p>${last.toFixed(1)}</p>
          <div class="trend ${trend}">
            ${trend==='up'? '‚Üë':'‚Üì'} ${Math.abs(pct)}%
          </div>`;
        container.appendChild(card);
      });
    }

    function renderChart(data, metric) {
      const ctx = document.getElementById('evolChart').getContext('2d');
      const labels = data.map(r=>new Date(r.Fecha).toLocaleDateString());
      const values = data.map(r=>parseFloat(r[metric])||0);
      if(window.eChart) window.eChart.destroy();
      window.eChart = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{
          label: metric, data:values,
          borderColor:getComputedStyle(document.documentElement).getPropertyValue('--primary'),
          backgroundColor:getComputedStyle(document.documentElement).getPropertyValue('--primary')+'33',
          fill:true, tension:0.3, pointRadius:4
        }]},
        options:{
          responsive:true,
          plugins:{ tooltip:{ callbacks:{
            label:ctx=>`${ctx.dataset.label}: ${ctx.parsed.y}` 
          }}},
          scales:{ x:{ title:{ display:true, text:'Fecha' }}, y:{ title:{ display:true, text:metric } }}
        }
      });
    }

    function renderComparison(data) {
      const first = data[0], last = data[data.length-1];
      const keys = [
        {k:'Peso corporal Kg',label:'Peso (Kg)'},
        {k:'BMI (√çndice Masa Corporal)',label:'BMI'},
        {k:'% Grasa corporal',label:'% Grasa'},
        {k:'Masa muscular Kg',label:'Masa Muscular'},
        {k:'% Agua total del cuerpo',label:'% Agua'},
        {k:'BMR (Tasa Metab√≥lica Basal)',label:'BMR'},
        {k:'Edad metab√≥lica',label:'Edad Metab√≥lica'},
        {k:'Nivel de grasa visceral',label:'Grasa Visceral'}
      ];
      const tbody = document.getElementById('comparisonBody');
      tbody.innerHTML = '';
      keys.forEach(m=>{
        const a=parseFloat(first[m.k]), b=parseFloat(last[m.k]);
        const diff=(b-a).toFixed(1), sign=diff>=0?'+':'';
        const status = diff<0 ? 'Mejora' : 'Empeor√≥';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${m.label}</td>
          <td>${a.toFixed(1)}</td>
          <td>${b.toFixed(1)}</td>
          <td>${sign}${diff}</td>
          <td class="${status==='Mejora'?'positive':'negative'}">${status}</td>`;
        tbody.appendChild(tr);
      });
    }

    async function applyClient(c) {
      const params = c? `?nombre=${encodeURIComponent(c.split('|')[0])}&apellido=${encodeURIComponent(c.split('|')[1])}`:'';
      const data = await fetchData(params);
      rawData = data;
      if(!rawData.length) return;
      createCards(rawData);
      renderChart(rawData, document.getElementById('chartMetricSelect').value);
      renderComparison(rawData);
    }

    async function init() {
      const sel = document.getElementById('clienteSelect');
      const metSel = document.getElementById('chartMetricSelect');
      const data = await fetchData();
      const clients = [...new Set(data.map(r=>`${r.Nombre}|${r.Apellidos}`))];
      clients.forEach(c=>{
        const [n,a] = c.split('|');
        const opt = document.createElement('option');
        opt.value=c; opt.textContent=`${n} ${a}`;
        sel.appendChild(opt);
      });
      sel.addEventListener('change', ()=>applyClient(sel.value));
      metSel.addEventListener('change', ()=>renderChart(rawData, metSel.value));
      applyClient(''); 
    }

    init();
  </script>
</body>
</html>
