<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Evolución Biomédica</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <div class="wrapper">
    <h1>📊 Evolución Biomédica</h1>
    <div class="filters">
      <label>Cliente
        <select id="clienteSelect">
          <option value="">—Cargando—</option>
        </select>
      </label>
      <label>Desde
        <input type="date" id="fromDate"/>
      </label>
      <label>Hasta
        <input type="date" id="toDate"/>
      </label>
      <button id="applyFilter">Aplicar filtro</button>
    </div>
    <div class="charts" id="chartsGrid"></div>
    <table class="data-table" id="dataTable">
      <thead>
        <tr><th>Fecha</th><th>Métrica</th><th>Valor</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <h2 style="text-align:center; margin-bottom:16px;">📋 Resumen Estadístico</h2>
    <table class="summary-table" id="summaryTable">
      <thead>
        <tr>
          <th>Métrica</th><th>Inicial</th><th>Final</th>
          <th>Diferencia</th><th>Óptimo</th><th>Estado</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const SHEET_URL = 'https://script.google.com/macros/s/AKfycbw4p-6JUt9kx5K5qbFSWffaX9FtEQ0tK_ptRrYTSlZzIr-MxlAZPEIr0MK22fvDboGrUw/exec';
    let rawData = [];

    async function fetchData(params='') {
      const res = await fetch(SHEET_URL + params);
      return res.json();
    }

    function buildCharts(data) {
      const metrics = [
        { key:'Peso corporal Kg', label:'Peso (Kg)', color:'#28a745' },
        { key:'BMI (Índice Masa Corporal)', label:'BMI', color:'#17a2b8' },
        { key:'% Grasa corporal', label:'% Grasa', color:'#f5576c' },
        { key:'% Agua total del cuerpo', label:'% Agua', color:'#28a745' },
        { key:'Masa muscular Kg', label:'Masa Muscular', color:'#17a2b8' },
        { key:'BMR (Tasa Metabólica Basal)', label:'BMR', color:'#28a745' },
        { key:'Edad metabólica', label:'Edad Metabólica', color:'#17a2b8' },
        { key:'Nivel de grasa visceral', label:'Grasa Visceral', color:'#f5576c' }
      ];
      const dates = data.map(r => new Date(r.Fecha).toLocaleDateString());
      const container = document.getElementById('chartsGrid');
      container.innerHTML = '';
      metrics.forEach(m => {
        const id = 'chart_' + m.key.replace(/\s+/g,'');
        container.innerHTML += `
          <div class="chart-card">
            <h3>${m.label}</h3>
            <canvas id="${id}"></canvas>
          </div>`;
        const ctx = document.getElementById(id).getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [{
              data: data.map(r => parseFloat(r[m.key]) || 0),
              borderColor: m.color,
              backgroundColor: m.color + '33',
              fill: true,
              tension: 0.3,
              pointRadius: 3
            }]
          },
          options: { responsive: true, scales: { x: { grid: { display: false } } } }
        });
      });
    }

    function buildTable(data) {
      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML = '';
      data.forEach(r => {
        Object.entries(r).forEach(([k,v]) => {
          if (k === 'Fecha' || isNaN(parseFloat(v))) return;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${new Date(r.Fecha).toLocaleDateString()}</td>
            <td>${k}</td>
            <td>${v}</td>`;
          tbody.appendChild(tr);
        });
      });
    }

    function buildSummary(data) {
      if (data.length < 2) return;
      const first = data[0], last = data[data.length-1];
      const metrics = [
        { key:'Peso corporal Kg', label:'Peso (Kg)', optimal:'IMC 18.5–24.9', classify:v=>v<18.5?'Bajo peso':v<25?'Normal':'Sobrepeso' },
        { key:'BMI (Índice Masa Corporal)', label:'BMI', optimal:'18.5–24.9', classify:v=>v<18.5?'Bajo peso':v<25?'Normal':'Sobrepeso' },
        { key:'% Grasa corporal', label:'% Grasa', optimal:'10–20% H / 18–28% M', classify:v=>v<10?'Bajo':v<=28?'Saludable':'Alto' },
        { key:'Nivel de grasa visceral', label:'Grasa Visceral', optimal:'1–9', classify:v=>v<=9?'Saludable':v<=14?'Moderado':'Alto riesgo' }
      ];
      const tbody = document.querySelector('#summaryTable tbody');
      tbody.innerHTML = '';
      metrics.forEach(m => {
        const a = parseFloat(first[m.key]), b = parseFloat(last[m.key]);
        if (isNaN(a)||isNaN(b)) return;
        const diff = (b - a).toFixed(1), sign = diff>=0?'+':'';
        const status = m.classify(b);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${m.label}</td>
          <td>${a.toFixed(1)}</td>
          <td>${b.toFixed(1)}</td>
          <td>${sign}${diff}</td>
          <td>${m.optimal}</td>
          <td class="${status==='Normal'||status==='Saludable'?'summary-positive':'summary-negative'}">${status}</td>`;
        tbody.appendChild(tr);
      });
    }

    async function applyFilter() {
      const cliente = document.getElementById('clienteSelect').value;
      let params = cliente
        ? `?nombre=${encodeURIComponent(cliente.split(' ')[0])}&apellido=${encodeURIComponent(cliente.split(' ')[1]||'')}`
        : '';
      const from = document.getElementById('fromDate').value;
      const to = document.getElementById('toDate').value;
      if (from) params += (params?'&':'?') + `from=${from}`;
      if (to) params   += (params?'&':'?') + `to=${to}`;
      const data = await fetchData(params);
      buildCharts(data);
      buildTable(data);
      buildSummary(data);
    }

    async function init() {
      const data = await fetchData();
      const sel = document.getElementById('clienteSelect');
      [...new Set(data.map(r=>r.Nombre+' '+r.Apellidos))].forEach(n => {
        const o = document.createElement('option');
        o.value = n; o.textContent = n;
        sel.appendChild(o);
      });
      document.getElementById('applyFilter').addEventListener('click', applyFilter);
      buildCharts(data);
      buildTable(data);
      buildSummary(data);
    }

    init();
  </script>
</body>
</html>
